Bootstrap: docker
From: condaforge/miniforge3:latest

%files
    environment_apptainer.yml /environment_apptainer.yml

%post
    # Update and install necessary packages
    apt-get update && \
        DEBIAN_FRONTEND=noninteractive TZ=Europe/Amsterdam \
        apt-get install -y tree time vim ncdu speedtest-cli build-essential

    apt-get install -y libstdc++6 
    apt-get install -y libxrender1
    apt-get install -y libxext6
    

    # Create a new Conda environment 
    conda update -n base -c defaults conda
    mamba env create --quiet --file /environment_apptainer.yml

    # Activate the environment and run post-install steps
    /bin/bash -c "source /opt/conda/etc/profile.d/conda.sh && \
                  conda activate __apptainer__ && \
                  python -m pip install xgboost==3.0.5 --no-deps"

    # Clean up
    apt-get clean && rm -rf /var/lib/apt/lists/*
    mamba clean --all -y

    # Now add the script to activate the Conda environment
    echo '. "/opt/conda/etc/profile.d/conda.sh"' >> $APPTAINER_ENVIRONMENT
    echo 'conda activate __apptainer__' >> $APPTAINER_ENVIRONMENT
    echo 'export METIS_DLL=$CONDA_PREFIX/lib/libmetis.so' >> $APPTAINER_ENVIRONMENT